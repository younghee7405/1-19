import pandas as pd
import numpy as np


# df= pd.read_csv("./raw_trade_data.csv" , encoding ="utf-8-sig")
# df= pd.read_csv("./raw_trade_data.csv" , encoding ="cp949")
df = pd.read_csv("./raw_trade_data.csv", encoding="euc-kr")
# print(df)

# 1. hs85

print("\n -------- ê³¼ì œ 1 ì‹œì‘ ë°˜ë„ì²´ ìˆ˜ì¶œ ë³´ê³ ì„œ ìƒì„± -------")
# 1. HS 85 ì‹œì‘
# print(df.info()) int64

cond_hs = df["hs_code"].astype(str).str.startswith("85")
# 2. ë¯¸êµ­ ë² íŠ¸ë‚¨ í•„í„°ë§ êµ­ê°€ëª…
cond_country = df["êµ­ê°€ëª…"].isin(["ë¯¸êµ­","ë² íŠ¸ë‚¨"])

# 3. ìˆ˜ì¶œê¸ˆì•¡ì´ 0ì› ë°ì´í„° ì œì™¸
cond_value = df["ìˆ˜ì¶œê¸ˆì•¡"] > 0

step1= df[cond_hs]
step2= step1[cond_country]
step3= step2[cond_value]

print("ìƒìœ„ 10ê°œ ë°ì´í„° í™•ì¸")
print(step3.head(10))

# step3.to_scv(" "  ,)

# ê³¼ì œ2
print("\n--- ğŸ† ê³¼ì œ 2 ì‹œì‘: ë°ì´í„° í´ë Œì§• ë° ì •ê·œí™” ---")

# (1) 'ì¤‘ëŸ‰' ì»¬ëŸ¼ ê²°ì¸¡ì¹˜ ì²˜ë¦¬ (map ëŒ€ì‹  ëª…ì‹œì  ë°˜ë³µë¬¸ í™œìš©)
# [ì˜¤ë¥˜ í•´ê²°] hs_means ë³€ìˆ˜ë¥¼ ëª…í™•í•˜ê²Œ ì •ì˜í•©ë‹ˆë‹¤.
hs_means = df.groupby('hs_code')['ì¤‘ëŸ‰'].mean()

# mapì„ ì“°ì§€ ì•ŠëŠ”ë‹¤ë©´, ê³„ì‚°ëœ í‰ê· ê°’ ëª©ë¡(hs_means)ì„ í•˜ë‚˜ì”© ëŒë©´ì„œ ìˆ˜ë™ìœ¼ë¡œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
for hs in hs_means.index:
    # 1. í˜„ì¬ ìˆœì„œì˜ HSì½”ë“œì— í•´ë‹¹í•˜ëŠ” í‰ê· ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    avg_val = hs_means[hs]
    
    # 2. ì›ë³¸ ë°ì´í„°ì—ì„œ [í•´ë‹¹ HSì½”ë“œì´ë©´ì„œ + ì¤‘ëŸ‰ì´ ë¹„ì–´ìˆëŠ”(NaN)] í–‰ë§Œ ì°¾ìŠµë‹ˆë‹¤.
    target_mask = (df['hs_code'] == hs) & (df['ì¤‘ëŸ‰'].isna())
    
    # 3. í•´ë‹¹ë˜ëŠ” ì¹¸ì—ë§Œ í‰ê· ê°’ì„ ëŒ€ì…í•©ë‹ˆë‹¤.
    df.loc[target_mask, 'ì¤‘ëŸ‰'] = avg_val

# ë§Œì•½ íŠ¹ì • í’ˆëª© ì „ì²´ê°€ NaNì´ë¼ í‰ê· ì„ êµ¬í•  ìˆ˜ ì—†ëŠ” ê²½ìš° 0ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
df.loc[df['ì¤‘ëŸ‰'].isna(), 'ì¤‘ëŸ‰'] = 0
print("âœ… ê²°ì¸¡ì¹˜ ì²˜ë¦¬ ì™„ë£Œ (ë°˜ë³µë¬¸ì„ í†µí•œ ìˆ˜ë™ ë§¤í•‘ ì ìš©)")

# (2) 'ìˆ˜ì¶œì…êµ¬ë¶„' ì»¬ëŸ¼ ì˜ë¬¸ -> êµ­ë¬¸ ë³€ê²½ (replace ì—†ì´ .loc í™œìš©)
# ì¡°ê±´ì— ë§ëŠ” í–‰ì„ ì°¾ì•„ ì§ì ‘ ê°’ì„ ëŒ€ì…í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
df.loc[df['ìˆ˜ì¶œì…êµ¬ë¶„'] == 'Export', 'ìˆ˜ì¶œì…êµ¬ë¶„'] = 'ìˆ˜ì¶œ'
df.loc[df['ìˆ˜ì¶œì…êµ¬ë¶„'] == 'Import', 'ìˆ˜ì¶œì…êµ¬ë¶„'] = 'ìˆ˜ì…'
print("âœ… ì»¬ëŸ¼ ë ˆì´ë¸” ë³€ê²½ ì™„ë£Œ (Export/Import -> ìˆ˜ì¶œ/ìˆ˜ì…)")

# (3) ìˆ˜ì¶œê¸ˆì•¡ ë‹¨ìœ„ ë³€í™˜: ì›(KRW) -> ë°±ë§Œ ë‹¬ëŸ¬(M_USD)
# í™˜ìœ¨ 1,470ì› ì ìš©
exchange_rate = 1470
df['ìˆ˜ì¶œê¸ˆì•¡_M_USD'] = (df['ìˆ˜ì¶œê¸ˆì•¡'] / exchange_rate) / 1000000
print(f"âœ… ë‹¨ìœ„ ë³€í™˜ ì™„ë£Œ (ì ìš© í™˜ìœ¨: {exchange_rate:,.0f}ì›)")

# (4) ë³€ê²½ í›„ ë°ì´í„° íƒ€ì… ë° ìµœì¢… í™•ì¸
print("\n--- [ìµœì¢… ë°ì´í„° íƒ€ì… í™•ì¸] ---")
print(df.dtypes)

print("\n--- [í´ë Œì§• ê²°ê³¼ ìƒ˜í”Œ í™•ì¸] ---")
print(df[['í†µê´€ë²ˆí˜¸', 'ìˆ˜ì¶œì…êµ¬ë¶„', 'ì¤‘ëŸ‰', 'ìˆ˜ì¶œê¸ˆì•¡_M_USD']].head())

# ìµœì¢… ì •ì œëœ ë°ì´í„° ì €ì¥
df.to_csv('./cleaned_trade_data.csv', index=False, encoding='cp949')
print("\nâœ… ê³¼ì œ 2 ì™„ë£Œ: 'cleaned_trade_data.csv' ì €ì¥ë¨")